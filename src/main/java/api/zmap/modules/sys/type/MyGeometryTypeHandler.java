package api.zmap.modules.sys.type;

import org.apache.ibatis.type.BaseTypeHandler;
import org.apache.ibatis.type.JdbcType;
import org.apache.ibatis.type.MappedTypes;
import org.postgis.PGgeometry;

import java.sql.CallableStatement;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

@MappedTypes({String.class})
public class MyGeometryTypeHandler extends BaseTypeHandler<String> {
    @Override
    public void setNonNullParameter(PreparedStatement ps, int i, String parameter, JdbcType jdbcType) throws SQLException {
        PGgeometry pGgeometry = new PGgeometry(parameter);
        ps.setObject(i, pGgeometry);
    }

    @Override
    public String getNullableResult(ResultSet rs, String columnName) throws SQLException {
        String geomStr=rs.getString(columnName);
        //01010000009A99999999995B409A99999999193440//point ok
        //0106000020E6100000010000000103000000010000002B0000000986DD1C43315D40668A72B45E31424079FC6C9D3F315D404E5622A45D314240723F615B3F315D40570FEF9B5E31424031D1638B3E315D4014ADCB6A61314240784C86A03D315D402EB3B723643142402AF3AA9B3C315D4088C013C4663142401E11CD7D3B315D40891D5849693142400E0A00483A315D40112C17B16B31424048506EFB38315D405ABEFFF86D3142402D45589937315D405F52DF1E703142405AB0601831315D40EEDC469E7931424010D01C832F315D40A023D0C77B314240329C0FD82D315D40E220C3C47D3142401D6D19192C315D40235EE3927F3142403B0031482A315D40780F2930813142408D42616728315D40365CC39A823142407404C77826315D40E7691AD1833142406C998E7E24315D40EE26D1D1843142404466F17A22315D403DD3C69B85314240AE60337020315D401445182E86314240886C5CD01F315D40F03B105286314240C25891B01C315D405C540A06873142403F0837361B315D40E9EF06068D3142404F6961EA20315D40377172BD8B31424083F46FF522315D403DC6EC2D8B3142400BAE48FA24315D40500C416C8A31424097A914F726315D40D8B91F79893142407A5004EA28315D40D055665588314240100851D12A315D40EDAD1E0287314240F6CF3EAB2C315D4070E47D808531424092D61D762E315D407A56E3D1833142408B024C3030315D40E75BD7F781314240BC6F36D831315D40D1E109F47F31424047DE5A6C33315D400CE150C87D3142401A7352ED39315D407E56E948743142408E46C0763B315D40EBEAF0E571314240A3BF45E83C315D40D364275D6F314240EDE37E403E315D4073C6FDB06C314240FA17207E3F315D403B2607E469314240C35EF79F40315D40D633F6F8663142407480EDA441315D40D69E9AF2633142406717
        // 078C42315D405961DED3603142400986DD1C43315D40668A72B45E314240
        //0106000020E6100000010000000103000000010000002B0000000986DD1C43315D40668A72B45E31424079FC6C9D3F315D404E5622A45D314240723F615B3F315D40570FEF9B5E31424031D1638B3E315D4014ADCB6A61314240784C86A03D315D402EB3B723643142402AF3AA9B3C315D4088C013C4663142401E11CD7D3B315D40891D5849693142400E0A00483A315D40112C17B16B31424048506EFB38315D405ABEFFF86D3142402D45589937315D405F52DF1E703142405AB0601831315D40EEDC469E7931424010D01C832F315D40A023D0C77B314240329C0FD82D315D40E220C3C47D3142401D6D19192C315D40235EE3927F3142403B0031482A315D40780F2930813142408D42616728315D40365CC39A823142407404C77826315D40E7691AD1833142406C998E7E24315D40EE26D1D1843142404466F17A22315D403DD3C69B85314240AE60337020315D401445182E86314240886C5CD01F315D40F03B105286314240C25891B01C315D405C540A06873142403F0837361B315D40E9EF06068D3142404F6961EA20315D40377172BD8B31424083F46FF522315D403DC6EC2D8B3142400BAE48FA24315D40500C416C8A31424097A914F726315D40D8B91F79893142407A5004EA28315D40D055665588314240100851D12A315D40EDAD1E0287314240F6CF3EAB2C315D4070E47D808531424092D61D762E315D407A56E3D1833142408B024C3030315D40E75BD7F781314240BC6F36D831315D40D1E109F47F31424047DE5A6C33315D400CE150C87D3142401A7352ED39315D407E56E948743142408E46C0763B315D40EBEAF0E571314240A3BF45E83C315D40D364275D6F314240EDE37E403E315D4073C6FDB06C314240FA17207E3F315D403B2607E469314240C35EF79F40315D40D633F6F8663142407480EDA441315D40D69E9AF2633142406717
        // 078C42315D405961DED3603142400986DD1C43315D40668A72B45E314240
        PGgeometry pGgeometry = new PGgeometry(rs.getString(columnName));//at api.zmap.modules.sys.type.MyGeometryTypeHandler.getNullableResult
        if (pGgeometry == null) {
            return null;
        }
        //SRID=4326;MULTIPOLYGON(((116.76993472693574 36.38573512562742,116.76972123749887 36.385702663353,116.76968670425745 36.385767446578676,116.7696316057618 36.38586266285281,116.7695693877861 36.385954973106955,116.76950028446015 36.38604402997235,116.76942455582372 36.386129498322894,116.769342486848 36.386211056536304,116.76925438636327 36.38628839770435,116.76916058589669 36.38636123078776,116.76876362680296 36.386651076785796,116.76866727176724 36.386717324090235,116.76856620238156 36.38677881255699,116.76846077836879 36.3868353233383,116.76835137495058 36.386886655302874,116.76823838151199 36.38693262575166,116.76812220021557 36.386973071068155,116.76800324456995 36.38700784730071,116.76788193795817 36.3870368306749,116.76775871213071 36.38705991803406,116.76763400566891 36.38707702720642,116.76728587507476 36.387116197001724,116.76719566873993 36.387299300890774,116.76738635431505 36.3872778459682,116.76766313560779 36.387246704015254,116.76778809386002 36.38722983752634,116.76791173790551 36.387207513479744,116.76803370290732 36.38717979774711,116.7681536289829 36.38714677210935,116.7682708806084 36.38710863289454,116.76838540672149 36.387065418443306,116.76849687102509 36.38701725565158,116.76860494621286 36.38696428594566,116.76870931493032 36.38690666486702,116.76880967070679 36.386844561615526,116.76890571885525 36.38677815855257,
        //116.76930267794899 36.38648831255453,116.76940585881249 36.3864081958736,116.76950276965077 36.38632312026598,116.76959304578025 36.386233405878315,116.76967634748432 36.38613939031333,116.76975236129167 36.386041427359466,116.769820801156 36.38593988565951,116.76988140953239 36.38583514732336,116.76993472693574 36.38573512562742)))
        String res=pGgeometry.toString();
        String res2="MULTIPOLYGON(((116.76993472693574 36.38573512562742,116.76972123749887 36.385702663353,116.76968670425745 36.385767446578676)))";
        //res2="POINT(110.4 20.1)";
        return pGgeometry.toString();
    }

    @Override
    public String getNullableResult(ResultSet rs, int columnIndex) throws SQLException {
        PGgeometry pGgeometry = new PGgeometry(rs.getString(columnIndex));
        if (pGgeometry == null) {
            return null;
        }
        return pGgeometry.toString();
    }

    @Override
    public String getNullableResult(CallableStatement cs, int columnIndex) throws SQLException {

        PGgeometry pGgeometry = new PGgeometry(cs.getString(columnIndex));
        if (pGgeometry == null) {
            return null;
        }
        return pGgeometry.toString();
    }
}